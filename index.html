<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine's Love Letter</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #e0f7fa, #fce4ec, #f3e5f5);
            color: #333;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative;
        }
        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #fff, #ffb3ba);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .container:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #ff69b4;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        textarea, select, input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ffb3ba;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        textarea:focus, select:focus, input:focus {
            border-color: #ff69b4;
            outline: none;
        }
        button {
            background: linear-gradient(45deg, #ff69b4, #ffb3ba);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255,105,180,0.4);
        }
        .letter {
            background: #fce4ec;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-style: italic;
            box-shadow: inset 0 0 10px rgba(255,105,180,0.2);
        }
        .game-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }
        canvas {
            border: 2px solid #ffb3ba;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
        }
        .controls {
            text-align: center;
            margin-top: 10px;
        }
        .music-controls {
            text-align: center;
            margin: 20px 0;
        }
        audio {
            width: 100%;
            max-width: 300px;
        }
        footer {
            text-align: center;
            margin-top: 50px;
            color: #ff69b4;
            font-size: 1.2em;
            text-shadow: 0 0 10px #ffb3ba;
        }
        @media (max-width: 600px) {
            h1 { font-size: 2em; }
            .container { margin: 20px; padding: 15px; }
            .game-container { width: 95%; }
        }
    </style>
</head>
<body>
    <div id="sparkles"></div>
    <div class="container" id="sender">
        <h1>ðŸ’– Create Your Love Letter ðŸ’–</h1>
        <textarea id="letterText" rows="10" placeholder="Write your heartfelt message here... (keep under 200 characters for shorter links)"></textarea>
        <select id="musicSelect">
            <option value="">Choose background music</option>
            <option value="builtin-blue">Built-in: Blue by Yung Kai</option>
            <option value="upload">Upload Custom MP3</option>
            <option value="url">Paste Custom MP3 URL</option>
        </select>
        <input type="file" id="musicFile" accept="audio/*" style="display: none;" placeholder="Choose your custom music file (MP3 from your folder)">
        <input type="url" id="musicUrl" style="display: none;" placeholder="Paste direct MP3 URL (e.g., from YouTube to MP3)">
        <button onclick="generateLink()">Generate Shareable Link</button>
        <p id="linkOutput"></p>
    </div>
    <div class="container" id="recipient" style="display: none;">
        <h1>ðŸ’Œ Your Love Letter ðŸ’Œ</h1>
        <div class="letter" id="displayLetter"></div>
        <div class="music-controls">
            <button onclick="playMusic()">Play Music</button>
            <button onclick="pauseMusic()">Pause</button>
            <button onclick="stopMusic()">Stop</button>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5" onchange="setVolume()">
        </div>
        <audio id="audioPlayer" controls style="display: none;"></audio>
        <button onclick="showGame()">Play this Game</button>
    </div>
    <div class="game-container" id="game">
        <h2>Heart Catching Game</h2>
        <canvas id="gameCanvas" width="300" height="400"></canvas>
        <div class="controls">
            <p>Score: <span id="score">0</span> | Time: <span id="timer">30</span>s</p>
            <button onclick="startGame()">Start</button>
            <button onclick="replayGame()" style="display: none;" id="replayBtn">Replay</button>
        </div>
        <button onclick="closeGame()">Close</button>
    </div>
    <footer>ðŸ’– Made with love by Cassandra Tereza S. Fernandez</footer>

    <script>
        // Floating sparkles
        function createSparkles() {
            const sparklesContainer = document.getElementById('sparkles');
            for (let i = 0; i < 20; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 6 + 's';
                sparklesContainer.appendChild(sparkle);
            }
        }
        createSparkles();

        // URL handling
        const urlParams = new URLSearchParams(window.location.search);
        const data = urlParams.get('data');
        if (data) {
            try {
                const decoded = JSON.parse(atob(data));
                document.getElementById('sender').style.display = 'none';
                document.getElementById('recipient').style.display = 'block';
                document.getElementById('displayLetter').textContent = decoded.letter || 'No letter provided.';
                const audioPlayer = document.getElementById('audioPlayer');
                if (decoded.music) {
                    audioPlayer.src = decoded.music;
                    audioPlayer.load(); // Ensure it loads
                } else {
                    alert('No music provided. Music controls may not work.');
                }
            } catch (e) {
                alert('Invalid link data.');
            }
        }

        // Show/hide inputs based on select
        document.getElementById('musicSelect').addEventListener('change', function() {
            const fileInput = document.getElementById('musicFile');
            const urlInput = document.getElementById('musicUrl');
            fileInput.style.display = 'none';
            urlInput.style.display = 'none';
            if (this.value === 'upload') {
                fileInput.style.display = 'block';
            } else if (this.value === 'url') {
                urlInput.style.display = 'block';
            }
        });

        function generateLink() {
            const letter = document.getElementById('letterText').value.trim();
            const musicChoice = document.getElementById('musicSelect').value;
            let music = '';
            if (!letter) {
                alert('Please write a letter!');
                return;
            }
            if (letter.length > 200) { // Reduced to 200 for shorter links
                alert('Letter is too long. Please shorten it to under 200 characters for shorter links.');
                return;
            }
            if (!musicChoice) {
                alert('Please choose music!');
                return;
            }
            if (musicChoice === 'builtin-blue') {
                music = 'https://www.soundjay.com/misc/sounds/love-song-01.mp3'; // Short URL
            } else if (musicChoice === 'upload') {
                const musicFile = document.getElementById('musicFile').files[0];
                if (!musicFile) {
                    alert('Please select a music file!');
                    return;
                }
                if (musicFile.size > 1 * 1024 * 1024) { // Reduced to 1MB for shorter links
                    alert('File is too large. Please use a smaller MP3 (under 1MB) or paste a URL instead.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    music = e.target.result;
                    finalizeLink(letter, music);
                };
                reader.onerror = function() {
                    alert('Error reading the file. Please try again.');
                };
                reader.readAsDataURL(musicFile);
                return; // Wait for reader
            } else if (musicChoice === 'url') {
                music = document.getElementById('musicUrl').value.trim();
                if (!music) {
                    alert('Please paste a music URL!');
                    return;
                }
            }
            finalizeLink(letter, music);
        }

        function finalizeLink(letter, music) {
            try {
                const data = btoa(JSON.stringify({ letter, music }));
                const baseUrl = 'https://fernandezcassandratereza-art.github.io/valentines/';
                const link = `${baseUrl}?data=${data}`;
                if (link.length > 2000) {
                    alert('Link is too long! Shorten the letter or use a URL for music. Try tinyurl.com or goo.gl to shorten it.');
                    document.getElementById('linkOutput').innerHTML = `Link too long: ${link.substring(0, 100)}... (Use a shortener)`;
                    return;
                }
                document.getElementById('linkOutput').innerHTML = `Share this link: <a href="${link}" target="_blank">${link}</a>`;
                alert('Link generated successfully! If long, use tinyurl.com to shorten.');
            } catch (e) {
                alert('Error generating link. Try shortening the letter.');
            }
        }

        // Music controls with error handling
        function playMusic() {
            const audio = document.getElementById('audioPlayer');
            if (audio.src) {
                audio.play().catch(e => alert('Unable to play music. Check if the URL is valid or try uploading a file.'));
            } else {
                alert('No music loaded.');
            }
        }
        function pauseMusic() {
            document.getElementById('audioPlayer').pause();
        }
        function stopMusic() {
            const audio = document.getElementById('audioPlayer');
            audio.pause();
            audio.currentTime = 0;
        }
        function setVolume() {
            document.getElementById('audioPlayer').volume = document.getElementById('volume').value;
        }

        // Game logic
        let canvas, ctx, basket, hearts, score, timeLeft, gameInterval, timerInterval;
        const gravity = 0.2;
        const bounceDamping = 0.8;
        function showGame() { document.getElementById('game').style.display = 'block'; }
        function closeGame() { 
            document.getElementById('game').style.display = 'none';
            clearInterval(gameInterval);
            clearInterval(timerInterval);
        }
        function startGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            basket = { x: canvas.width / 2 - 25, y: canvas.height - 50, width: 50, height: 20 };
            hearts = [];
            score = 0;
            timeLeft = 30;
            document.getElementById('score').textContent = score;
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('replayBtn').style.display = 'none';
            gameInterval = setInterval(updateGame, 20);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(gameInterval);
                    clearInterval(timerInterval);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ff69b4';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Game Over! ðŸ’–', canvas.width / 2, canvas.height / 2 - 20);
                    ctx.fillText(`Final Score: ${score}`, canvas.width / 2, canvas.height / 2 + 20);
                    document.getElementById('replayBtn').style.display = 'inline';
                }
            }, 1000);
            canvas.addEventListener('mousemove', moveBasket);
            canvas.addEventListener('touchmove', moveBasketTouch);
        }
        function updateGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Draw basket
            ctx.fillStyle = '#ffb3ba';
            ctx.fillRect(basket.x, basket.y, basket.width, basket.height);
            // Add hearts
            if (Math.random() < 0.02) {
                hearts.push({ x: Math.random() * (canvas.width - 30), y: 0, size: 30, rotation: 0, vy: 0 });
            }
            // Update hearts
            hearts.forEach((heart, index) => {
                heart.vy += gravity;
                heart.y += heart.vy;
                heart.rotation += 0.1;
                // Bounce off bottom
                if (heart.y + heart.size > canvas.height) {
                    heart.y = canvas.height - heart.size;
                    heart.vy = -heart.vy * bounceDamping;
                }
                // Draw heart
                drawHeart(heart.x, heart.y, heart.size, heart.rotation);
                // Check collision with basket (only if falling down and near bottom)
                if (heart.vy > 0 && heart.y + heart.size >= basket.y && heart.x < basket.x + basket.width && heart.x + heart.size > basket.x) {
                    hearts.splice(index, 1);
                    score++;
                    document.getElementById('score').textContent = score;
                }
                // Remove off-screen hearts
                if (heart.y > canvas.height + 50) hearts.splice(index, 1);
            });
        }
        function drawHeart(x, y, size, rotation) {
            ctx.save();
            ctx.translate(x + size / 2, y + size / 2);
            ctx.rotate(rotation);
            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.moveTo(0, size / 4);
            ctx.bezierCurveTo(-size / 2, -size / 4, -size / 2, size / 2, 0, size);
            ctx.bezierCurveTo(size / 2, size / 2, size / 2, -size / 4, 0, size / 4);
            ctx.fill();
            ctx.restore();
        }
        function moveBasket(e) {
            const rect = canvas.getBoundingClientRect();
            basket.x = e.clientX - rect.left - basket.width / 2;
            basket.x = Math.max(0, Math.min(canvas.width - basket.width, basket.x));
        }
        function moveBasketTouch(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e